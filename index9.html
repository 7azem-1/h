<!DOCTYPE html>
<html>
<head>
  <title>تأكيد كود الحجز</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js"></script>
</head>
<body>
  <h2>تأكيد كود الحجز</h2>
  <input type="text" id="codeInput" placeholder="ادخل كود الحجز">
  <button onclick="checkCode()">تحقق</button>

  <div id="result"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyChXYUhXG3GliFPb5vp736Hhp7Msllxj68",
    authDomain: "mlaab-city.firebaseapp.com",
    projectId: "mlaab-city",
    storageBucket: "mlaab-city.firebasestorage.app",
    messagingSenderId: "910383180422",
    appId: "1:910383180422:web:3feb8fad61d2cab5917f07",
    measurementId: "G-YQ0016JLVH"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app); // قاعدة البيانات

    async function checkCode() {
      const code = document.getElementById("codeInput").value;
      const q = query(collection(db, "bookings"), where("code", "==", code));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        document.getElementById("result").innerText = "الكود غير موجود.";
        return;
      }

      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.expired) {
          document.getElementById("result").innerText = "❌ هذا الكود غير صالح (تم استخدامه).";
        } else {
          document.getElementById("result").innerHTML = `
            ✅ الاسم: ${data.name}<br>
            📞 الهاتف: ${data.phone}<br>
            📅 التاريخ: ${data.date}<br>
            🕒 الوقت: ${data.from}-${data.to} ${data.am_pm}<br>
            <button onclick="expireCode('${docSnap.id}')">تم استخدام الكود</button>
          `;
        }
      });
    }

    async function expireCode(docId) {
      const bookingRef = doc(db, "bookings", docId);
      await updateDoc(bookingRef, { expired: true });
      alert("✅ تم إنهاء صلاحية الكود.");
      document.getElementById("result").innerText = "❌ الكود الآن غير صالح.";
    }
  </script>
</body>
</html>
